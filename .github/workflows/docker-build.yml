name: Build Docker Image

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker build -f docker/Dockerfile -t argosbx-proxy .
        echo "âœ… Docker é•œåƒæ„å»ºæˆåŠŸ"

    - name: Test the image
      run: |
        echo "ğŸ§ª æµ‹è¯•è¿è¡Œå®¹å™¨..."
        docker run -d --name test-argosbx argosbx-proxy
        sleep 20
        echo "=== å®¹å™¨æ—¥å¿— ==="
        docker logs test-argosbx --tail 30
        echo "=== åœæ­¢å®¹å™¨ ==="
        docker stop test-argosbx
        docker rm test-argosbx
        echo "âœ… æµ‹è¯•å®Œæˆ!"

    - name: Save image
      run: |
        docker save argosbx-proxy -o argosbx-proxy.tar
        echo "ğŸ’¾ é•œåƒå·²ä¿å­˜: argosbx-proxy.tar ($(du -h argosbx-proxy.tar | cut -f1))"
        
    - name: Upload Docker image
      uses: actions/upload-artifact@v4
      with:
        name: argosbx-docker-image
        path: argosbx-proxy.tar
        retention-days: 30

    - name: Show usage instructions
      run: |
        echo ""
        echo "ğŸ‰ Argosbx Docker é•œåƒæ„å»ºæˆåŠŸ!"
        echo "=========================================="
        echo ""
        echo "ğŸ“¥ ä¸‹è½½å’Œä½¿ç”¨:"
        echo "1. ç‚¹å‡»ä¸Šæ–¹çš„ 'argosbx-docker-image' ä¸‹è½½é•œåƒæ–‡ä»¶"
        echo "2. åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ: docker load -i argosbx-proxy.tar"
        echo "3. è¿è¡Œå®¹å™¨: docker run -d --name argosbx argosbx-proxy"
        echo "4. æŸ¥çœ‹èŠ‚ç‚¹: docker exec argosbx agsbx list"
        echo ""
        echo "ğŸ”§ å¸¸ç”¨å‘½ä»¤:"
        echo "æŸ¥çœ‹æ—¥å¿—: docker logs argosbx"
        echo "é‡å¯æœåŠ¡: docker exec argosbx agsbx res"
        echo "é‡ç½®é…ç½®: docker exec argosbx agsbx rep"
        echo "å¸è½½åˆ é™¤: docker exec argosbx agsbx del"
        echo ""
        echo "ğŸŒ å¸¦ç«¯å£æ˜ å°„è¿è¡Œ:"
        echo "docker run -d \\"
        echo "  -p 443:443 -p 8443:8443 -p 2053:2053 \\"
        echo "  -p 2083:2083 -p 2087:2087 -p 2095:2095 \\"
        echo "  --name argosbx \\"
        echo "  argosbx-proxy"
        echo ""
        echo "âš™ï¸  è‡ªå®šä¹‰é…ç½®è¿è¡Œ:"
        echo "docker run -d \\"
        echo "  -e vlpt=443 -e hypt=8443 -e warp=s4x6 \\"
        echo "  -e name=my-proxy \\"
        echo "  -p 443:443 -p 8443:8443 \\"
        echo "  --name argosbx \\"
        echo "  argosbx-proxy"
